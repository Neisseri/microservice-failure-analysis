---
- name: Download and install sealos
  hosts: controller
  become: yes
  gather_facts: no
  tasks:
    - name: Download sealos
      get_url:
        url: https://github.com/labring/sealos/releases/download/v4.3.7/sealos_4.3.7_linux_amd64.tar.gz
        dest: /tmp/sealos_4.3.7_linux_amd64.tar.gz
        timeout: 600
      environment:
        http_proxy: "{{ hostvars['main']['proxy'] }}"
        https_proxy: "{{ hostvars['main']['proxy'] }}"

    - name: Extract sealos
      unarchive:
        src: /tmp/sealos_4.3.7_linux_amd64.tar.gz
        dest: /tmp/
        creates: /tmp/sealos

    - name: Ensure sealos is executable
      file:
        path: /tmp/sealos
        mode: '0755'
        state: file

    - name: Move sealos to /usr/bin
      command: mv /tmp/sealos /usr/bin/sealos

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install packages
      apt:
        name: 
          - uidmap
          - fuse-overlayfs
        state: present

- name: Install kubernetes via sealos
  hosts: controller
  become: yes
  gather_facts: no
  tasks:
    - name: Set sealos command
      set_fact:
        sealos_command: |
          sealos run labring/kubernetes:v1.24.17 \
          labring/helm:v3.13.2 \
          labring/flannel:v0.19.2 \
          --masters {{ hostvars['main']['ansible_host'] }} \
          --nodes {% for host in groups['workers'] %}{{ hostvars[host]['ansible_host'] }}{% if not loop.last %},{% endif %}{% endfor %} \
          --pk '{{ hostvars['main']['ssh_key'] }}' \
          --passwd '{{ hostvars['main']['ansible_become_pass'] }}' \
          --user {{ hostvars['main']['ansible_user'] }}

    - name: Debug sealos command
      debug:
        msg: "{{ sealos_command }}"

    - name: Check current user
      command: whoami
      register: whoami_output

    - name: Debug current user
      debug:
        msg: "Current user is {{ whoami_output.stdout }}"
        
    - name: Run sealos command
      shell: "{{ sealos_command }}"
      args:
        executable: /bin/bash
      environment:
        http_proxy: "{{ hostvars['main']['proxy'] }}"
        https_proxy: "{{ hostvars['main']['proxy'] }}"

- name: Expose kubernetes to all users
  hosts: controller
  gather_facts: yes
  tasks:
    - name: Ensure /etc/kubernetes/admin.conf is readable by all users
      become: yes
      file:
        path: /etc/kubernetes/admin.conf
        owner: root
        group: root
        mode: '0666'
        state: file

    - name: Ensure .kube directory exists
      become: no
      file:
        path: "{{ ansible_env.HOME }}/.kube"
        state: directory

    - name: Copy Kubernetes admin.conf to .kube/config
      become: yes
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "{{ ansible_env.HOME }}/.kube/config"
        remote_src: yes
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_id }}"
        mode: '0666'

    - name: Print ansible_env.HOME
      become: yes
      debug:
        msg: "The HOME directory is: {{ ansible_env.HOME }}"

    - name: Print ansible_user_id
      become: yes
      debug:
        msg: "The user ID is: {{ ansible_user_id }}"

- name: Ensure kubernetes python library is installed
  hosts: controller
  become: yes
  tasks:
    - name: Install pip3
      apt:
        name: python3-pip
        state: present

    - name: Install kubernetes library via pip
      pip:
        name: kubernetes
        executable: pip3
...